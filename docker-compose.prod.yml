version: "3.8"

# Production Docker Compose Configuration for ussy.host
# Only exposes frontend, backend secured behind nginx

services:
  # =====================
  # Qdrant Vector Database
  # =====================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: roo-rag-qdrant-prod
    restart: unless-stopped
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    # Not exposed publicly - only accessible from internal network
    networks:
      - rag-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # =====================
  # RAG Backend API
  # =====================
  rag-backend:
    build:
      context: ./rag-backend
      dockerfile: Dockerfile
    container_name: roo-rag-backend-prod
    restart: unless-stopped
    env_file:
      - ./rag-backend/.env
    environment:
      - NODE_ENV=production
      - QDRANT_URL=http://qdrant:6333
    # Only expose to localhost for Nginx proxy
    ports:
      - "127.0.0.1:3001:3001"
    depends_on:
      qdrant:
        condition: service_healthy
    networks:
      - rag-internal
    volumes:
      # Mount docs for ingestion (read-only)
      - ./docs:/app/docs:ro
      # Persist ingestion state
      - rag_state:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    # Memory limit for Node.js
    deploy:
      resources:
        limits:
          memory: 2G

  # =====================
  # Nginx Reverse Proxy (Production)
  # =====================
  nginx:
    image: nginx:alpine
    container_name: roo-rag-nginx-prod
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ops/nginx/roo-rag.conf:/etc/nginx/conf.d/default.conf:ro
      - ./build:/var/www/roo-docs/build:ro
      - nginx_ssl:/etc/nginx/ssl:ro
    depends_on:
      rag-backend:
        condition: service_healthy
    networks:
      - rag-internal

networks:
  rag-internal:
    driver: bridge
    internal: false

volumes:
  qdrant_storage:
    driver: local
  rag_state:
    driver: local
  nginx_ssl:
    driver: local